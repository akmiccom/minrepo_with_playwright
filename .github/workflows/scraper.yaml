name: scrape-minrepo

on:
  # schedule:
  #   # UTC基準。JST 03:05 は 前日の 18:05 UTC
  #   - cron: "0 21 * * *" # 日本時間6：00
  workflow_dispatch: {} # 手動実行ボタン

permissions:
  contents: read

concurrency:
  group: scrape-minrepo
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Randomize start (avoid bursts)
        run: sleep $((RANDOM % 180)) # 0〜179秒
  
      - name: Checkout
        uses: actions/checkout@v4
  
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
  
      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          python -m playwright install --with-deps
  
      - name: Run scraper
        env:
          TZ: Asia/Tokyo
          # 必要なら自分のUAや環境変数をここに。例:
          # SCRAPER_UA: ${{ secrets.SCRAPER_UA }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: python scraper/scraper.py
          # python -m scraper.main
  
      # デバッグ用成果物（失敗時も拾う）
      - name: Upload artifacts (logs/screens)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scrape-debug
          path: |
            logs/**
            debug/**
            **/*.png
            **/debug.html
          if-no-files-found: ignore
